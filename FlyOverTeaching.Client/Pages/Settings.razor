@page "/settings"
@using FlyOverTeaching.Client.Services
@using FlyOverTeaching.Shared.Models
@inject IDatabaseService DatabaseService
@inject ISnackbar Snackbar

<PageTitle>FlyOver Teaching - Settings</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Application Settings</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <i class="fas fa-palette me-2"></i> Theme Settings
            </MudText>
            
            <MudForm>
                <MudTextField @bind-Value="_themeSettings.Title" 
                             Label="Schedule Title" 
                             Variant="Variant.Outlined"
                             Class="mb-3" />
                
                <MudTextField @bind-Value="_themeSettings.Subtitle" 
                             Label="Schedule Subtitle" 
                             Variant="Variant.Outlined"
                             Class="mb-3" />
                
                <MudTextField @bind-Value="_themeSettings.Background" 
                             Label="Background Gradient" 
                             HelperText="CSS gradient value"
                             Variant="Variant.Outlined"
                             Class="mb-3" />
                
                <MudGrid>
                    <MudItem xs="6">
                        <MudColorPicker @bind-Text="_themeSettings.HeaderTextColor" 
                                       Label="Header Text Color"
                                       Style="@($"color: {_themeSettings.HeaderTextColor}")" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudColorPicker @bind-Text="_themeSettings.ControlsTextColor" 
                                       Label="Controls Text Color"
                                       Style="@($"color: {_themeSettings.ControlsTextColor}")" />
                    </MudItem>
                </MudGrid>
                
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveThemeSettings" Class="mt-3">
                    <i class="fas fa-save me-2"></i> Save Theme Settings
                </MudButton>
            </MudForm>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <i class="fas fa-file-pdf me-2"></i> PDF Export Settings
            </MudText>
            
            <MudForm>
                <MudGrid>
                    <MudItem xs="6">
                        <MudSelect @bind-Value="_pdfSettings.Orientation" 
                                  Label="Page Orientation" 
                                  Variant="Variant.Outlined">
                            <MudSelectItem Value="@("portrait")">Portrait</MudSelectItem>
                            <MudSelectItem Value="@("landscape")">Landscape</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6">
                        <MudSelect @bind-Value="_pdfSettings.PageSize" 
                                  Label="Page Size" 
                                  Variant="Variant.Outlined">
                            <MudSelectItem Value="@("letter")">Letter</MudSelectItem>
                            <MudSelectItem Value="@("a4")">A4</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>
                
                <MudNumericField @bind-Value="_pdfSettings.FontSize" 
                                Label="Font Size" 
                                Min="8" Max="16"
                                Variant="Variant.Outlined"
                                Class="mt-3" />
                
                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">Include in PDF:</MudText>
                <MudSwitch @bind-Value="_pdfSettings.IncludeHeader" Label="Header" Color="Color.Primary" />
                <MudSwitch @bind-Value="_pdfSettings.IncludeFooter" Label="Footer (Page Numbers)" Color="Color.Primary" />
                <MudSwitch @bind-Value="_pdfSettings.IncludeStudents" Label="Student Names" Color="Color.Primary" />
                <MudSwitch @bind-Value="_pdfSettings.IncludeNotes" Label="Notes" Color="Color.Primary" />
                <MudSwitch @bind-Value="_pdfSettings.UseColors" Label="Colors" Color="Color.Primary" />
                
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SavePdfSettings" Class="mt-3">
                    <i class="fas fa-save me-2"></i> Save PDF Settings
                </MudButton>
            </MudForm>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <i class="fas fa-database me-2"></i> Data Management
            </MudText>
            
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true" OnClick="ExportData">
                        <i class="fas fa-download me-2"></i> Export All Data
                    </MudButton>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth="true" OnClick="ImportData">
                        <i class="fas fa-upload me-2"></i> Import Data
                    </MudButton>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Warning" FullWidth="true" OnClick="ResetToDefaults">
                        <i class="fas fa-undo me-2"></i> Reset to Defaults
                    </MudButton>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Error" FullWidth="true" OnClick="ClearAllData">
                        <i class="fas fa-trash-alt me-2"></i> Clear All Data
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private ThemeSettings _themeSettings = new();
    private PdfSettings _pdfSettings = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        await DatabaseService.InitializeAsync();
        _themeSettings = await DatabaseService.GetThemeSettingsAsync();
        _pdfSettings = await DatabaseService.GetPdfSettingsAsync();
    }

    private async Task SaveThemeSettings()
    {
        await DatabaseService.UpdateThemeSettingsAsync(_themeSettings);
        Snackbar.Add("Theme settings saved successfully", Severity.Success);
    }

    private async Task SavePdfSettings()
    {
        await DatabaseService.UpdatePdfSettingsAsync(_pdfSettings);
        Snackbar.Add("PDF settings saved successfully", Severity.Success);
    }

    private async Task ExportData()
    {
        await DatabaseService.ExportDatabaseAsync("flyover-teaching-backup.json");
        Snackbar.Add("Data exported successfully", Severity.Success);
    }

    private async Task ImportData()
    {
        // This would open a file dialog in a real implementation
        Snackbar.Add("Import feature coming soon", Severity.Info);
    }

    private async Task ResetToDefaults()
    {
        await DatabaseService.ResetToDefaultsAsync();
        await LoadSettings();
        Snackbar.Add("Settings reset to defaults", Severity.Warning);
    }

    private async Task ClearAllData()
    {
        // This would show a confirmation dialog in a real implementation
        await DatabaseService.ResetToDefaultsAsync();
        Snackbar.Add("All data cleared", Severity.Warning);
    }
}